# Архитектура: брокеры сообщений

## Понимание брокеров сообщений. Изучение механики обмена сообщениями посредством ActiveMQ и Kafka. Глава 1 / Хабр

- https://habr.com/ru/articles/466385/

Распространенный сценарий, когда ваш код обмена сообщениями работает отлично, до поры до времени. Пока не перестает работать.

Без глубокого понимания того, как работают брокеры, люди делают, казалось бы, разумные утверждения об их системах обмена сообщениями, такие как:

- Система никогда не потеряет сообщения
- Сообщения будут обрабатываться последовательно
- Добавление консьюмеров сделает систему быстрее
- Сообщения будут доставлены только один раз

Чтобы два приложения могли общаться друг с другом, они должны сначала определить интерфейс: транспорт, протокол, формат сообщений. Пока поддерживается контракт, системы могут взаимодействовать друг с другом, не заботясь о реализации друг друга (язык программирования или фреймворк)

Системы обмена сообщениями, как правило, предусматривают участие посредника (брокера) между двумя системами, которые взаимодействуют для дальнейшего расцепления (разделения) отправителя от получателя или получателей. При этом система обмена сообщениями позволяет отправителю отправить сообщение, не зная, где находится получатель, активен ли он или сколько их экземпляров

### Point-to-point

"почтовое отделение". Очереди. FIFO (первый вошел, первый вышел).

_Надежность_ — это свойство сервиса, которое гарантирует, что система обмена сообщениями будет сохранять сообщения при отсутствии активных подписчиков до тех пор, пока потребитель не подпишется на очередь для доставки сообщений.

Надежность часто путают с _персистентностью_. Персистентность — сообщения записываются в какого-либо рода хранилище между получением и отправкой его потребителю.

Обмен сообщениями типа «Точка-точка» используется, когда вариант использования требует однократного действия с сообщением: внесение средств на счет или выполнение заказа на доставку.

### Издатель-Подписчик

Широковещательные системы.

Габриэлла набирает номер конференции. Пока она подключена к конференции, она слышит все, что говорит спикер, вместе с остальными участниками вызова. Когда она отключается, она пропускает то, что сказано. При повторном подключении она продолжает слышать, что говорят.

Cистема гарантирует, что любой подключившийся в настоящий момент услышит, что говорится.
В классических системах обмена сообщениями модель обмена сообщениями «публикация-подписка» реализуется через _топики_.

Топики обычно _ненадежные (nondurable)_. Гарантию доставки _не более одного раза_ для каждого потребителя.

Используется, когда потеря одного сообщения не особо значима. Пример: показания температуры от группы датчиков один раз в секунду.

### Гибридные модели

> Очередь заказов на web-сайте магазина. Потребители: исполнительная система, система аудита. Обе системы не могут пропускать сообщения, даже если сами системы в течение некоторого времени недоступны. Web-сайт не должен знать о количестве потребителей.

Часто требуются совмещение моделей обмена сообщениями «публикация-подписка» и «точка-точка». Например, когда нескольким системам требуется копия сообщения, и для предотвращения потери сообщения требуется как надежность, так и персистентность.

Один раз для каждой заинтересованной стороны.

Гибридные модели не новы и могут применяться в большинстве систем обмена сообщениями, включая как ActiveMQ (через виртуальные или составные адресаты, которые объединяют топики и очереди), так и Kafka (неявно, как фундаментальное свойство дизайна её адресата).

## Понимание брокеров сообщений. Изучение механики обмена сообщениями посредством ActiveMQ и Kafka. Глава 2. ActiveMQ / Хабр

- https://habr.com/ru/articles/471268/

Если мы не хотим потерять сообщения в случае сбоя брокера, нам нужно записать их в постоянное хранилище.  Но разница между скоростью записи мегабайта данных на диск в 100-1000 раз медленнее, чем запись в память

ActiveMQ поставляется с рядом подключаемых стратегий сохранения сообщений. Они идут в форме адаптеров персистентности - "движков" сохранения сообщений. К ним относятся решения, записывающие на диск (KahaDB, LevelDB), а также на возможности использования базы данных через JDBC.

Когда брокер получает персистентные сообщения, они сначала записываются на диск в журнал. Журнал — структура данных на диске из нескольких файлов, в которую можно только добавлять данные. Журнал содержит лог всех входящих сообщений, а также сведения о тех сообщениях, которые были подтверждены, как прочитанные клиентом.

Когда все сообщения из файла журнала будут прочитаны, они будут либо удалены, либо заархивированы фоновым рабочим потоком ActiveMQ. Если этот журнал поврежден во время сбоя брокера, ActiveMQ перестроит его на основе информации в файлах журнала.

Если одно сообщение не прочитано, то весь файл с ним (32 - 100 МБ), не может быть очищен.