# DevOps: deploy strategies

- :newspaper: [Стратегии деплоя в Kubernetes: rolling, recreate, blue/green, canary, dark (A/B-тестирование) | Хабр](https://habr.com/ru/companies/flant/articles/471620/)
- :newspaper: [Знакомство с Kubernetes. Часть 5: Развертывания (Deployments) · Yevhen Lebid's website](https://ealebed.github.io/posts/2018/знакомство-с-kubernetes-часть-5-deployments/)

## Rolling

Постепенное, один за другим, замещение pod'ов со старой версией приложения на pod'ы с новой версией.

```yaml
spec:
  replicas: 3
  strategy:
    type: RollingUpdate
    rollingUpdate:
       maxSurge: 25%
       maxUnavailable: 25%
```

`maxSurge` - необязательное поле, указывающее максимальное количество подов (Pods), которое может быть создано сверх желаемого количества подов (Pods), описанного в развертывании.

`maxUnavailable` - необязательное поле, указывающее максимальное количество подов, которые могут быть недоступны в процессе обновления.

## Recreate

Старые pod'ы убиваются все разом и заменяются новыми.

```yaml
  strategy:
    type: Recreate
```

## Blue/Green

Одновременное развертывание новой (синей) наряду со старой (зеленой) версией приложения. После размещения обеих версий обычные пользователи получают доступ к зеленой, в то время как синяя доступна для QA-команды для автоматизации тестов. После того, как синяя (новая) версия была протестирована и был одобрен ее релиз, сервис переключается на неё, а зеленая (старая) сворачивается:

```yaml
spec:
  selector:
    app: awesomeapp
    version: "02"
```

## Canary

Эта стратегия похожа на blue/green и применяется, когда необходимо испытать некую новую функциональность, как правило, в бэкенде приложения. Суть подхода в том, чтобы создать два практически одинаковых сервера: один обслуживает почти всех пользователей, а другой, с новыми функциями, обслуживает лишь небольшую подгруппу пользователей, после чего результаты их работы сравниваются.

Если все проходит без ошибок, новая версия постепенно выкатывается на всю инфраструктуру.Если все проходит без ошибок, новая версия постепенно выкатывается на всю инфраструктуру.

Для данной стратегии удобно использовать service mesh вроде Istio. Изменяя веса в манифесте виртуального шлюза Istio, можно управлять распределением трафика между этими двумя deployment'ами.

## Dark (скрытые) или А/В-развертывания

Скрытые развертывания имеют дело с фронтендом, а не с бэкендом, как канареечные.скрытые развертывания имеют дело с фронтендом, а не с бэкендом, как канареечные.

Скрытое развертывание: часть пользователи выступают тестерами-первопроходцами, но не знают об этом.

***Feature toggles*** — переключатели функциональности.

При А/В-тестировании можно использовать заголовки HTTP или файлы cookie для перенаправления определенного сегмента пользователей.  Frontend-приложений требуют привязки сессии к серверу (session affinity). Flagger.